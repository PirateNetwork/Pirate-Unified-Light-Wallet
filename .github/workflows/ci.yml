name: CI - Pirate Unified Wallet

on:
  push:
    branches: [main, develop]
    tags:
      - "v*"
  pull_request:
    branches: [main, develop]

env:
  RUST_VERSION: "1.90.0"
  FLUTTER_VERSION: "3.38.7"
  FRB_CODEGEN_VERSION: "2.11.1"
  GO_VERSION: "1.21.13"
  JAVA_VERSION: "25"
  COCOAPODS_VERSION: "1.16.2"
  APPIMAGETOOL_URL: "https://github.com/AppImage/AppImageKit/releases/download/13/obsolete-appimagetool-x86_64.AppImage"
  APPIMAGETOOL_SHA256: "df3baf5ca5facbecfc2f3fa6713c29ab9cefa8fd8c1eac5d283b79cab33e4acb"
  ANDROID_BUILD_TOOLS_VERSION: "34.0.0"
  ANDROID_PLATFORM_VERSION: "36"
  ANDROID_NDK_VERSION: "26.1.10909125"
  SYFT_VERSION: "1.40.1"
  SYFT_SHA256_LINUX_AMD64: "c229137c919f22aa926c1c015388db5ec64e99c078e0baac053808e8f36e2e00"
  SYFT_SHA256_DARWIN_ARM64: "c0f6a4fc0563ef1dfe1acf9a4518db66cb37bbb1391889aba3be773dff3487dd"
  SYFT_SHA256_DARWIN_AMD64: "9e84d1f152ef9d3bb541cc7cedf81ed4c7ed78f6cc2e4c8f0db9e052b64cd7be"
  SYFT_SHA256_WINDOWS_AMD64: "eedac363e277dfecac420b6e4ed0a861bc2c9c84a7544157f52807a99bff07cd"
  CARGO_AUDIT_VERSION: "0.22.0"
  CARGO_DENY_VERSION: "0.19.0"
  CARGO_AUDITABLE_VERSION: "0.7.2"
  CARGO_TERM_COLOR: always
  MSIX_VERSION: "3.16.13"

jobs:
  frb-codegen:
    name: FRB - Codegen
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-frb-${{ hashFiles('**/Cargo.lock') }}

      - name: Install flutter_rust_bridge_codegen
        run: cargo install flutter_rust_bridge_codegen --locked --version ${{ env.FRB_CODEGEN_VERSION }} --force

      - name: Prepare Flutter Dart toolchain
        run: |
          cd app
          flutter pub get --enforce-lockfile
          cd ..
          mkdir -p .dart_tool
          cp app/.dart_tool/package_config.json .dart_tool/package_config.json

      - name: Generate flutter_rust_bridge bindings
        run: |
          FRB_SIMPLE_BUILD_SKIP=1 flutter_rust_bridge_codegen generate --config-file flutter_rust_bridge.yaml

      - name: Verify bindings are up to date
        run: git diff --exit-code

  # ========================================================================
  # Rust Quality Gates
  # ========================================================================

  rust-lint:
    name: Rust - Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: crates/target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: |
          cd crates
          cargo fmt --all -- --check

      - name: Run clippy
        run: |
          cd crates
          cargo clippy --all-targets --all-features --locked -- -D warnings

  rust-test:
    name: Rust - Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            crates/target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}

      - name: Run unit tests
        run: |
          cd crates
          cargo test --all-features --locked

  rust-property-tests:
    name: Rust - Property Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            crates/target
          key: ${{ runner.os }}-cargo-proptest-${{ hashFiles('**/Cargo.lock') }}

      - name: Run property tests
        run: |
          cd crates/pirate-core
          cargo test --test property_tests --release --locked

  rust-migration-tests:
    name: Rust - Migration Snapshot Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            crates/target
          key: ${{ runner.os }}-cargo-migration-${{ hashFiles('**/Cargo.lock') }}

      - name: Run migration tests
        run: |
          cd crates/pirate-storage-sqlite
          cargo test --test migration_snapshots --locked

  rust-perf-tests:
    name: Rust - Performance Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            crates/target
          key: ${{ runner.os }}-cargo-perf-${{ hashFiles('**/Cargo.lock') }}

      - name: Run performance benchmarks
        run: |
          cd crates/pirate-sync-lightd
          cargo test --test performance_benchmarks --release --locked -- --nocapture

  # ========================================================================
  # Security Audits
  # ========================================================================

  security-audit:
    name: Security - Cargo Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked --version ${{ env.CARGO_AUDIT_VERSION }}

      - name: Run cargo audit
        run: |
          cd crates
          cargo audit --ignore RUSTSEC-2023-0071

  security-deny:
    name: Security - Cargo Deny
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked --version ${{ env.CARGO_DENY_VERSION }}

      - name: Run cargo deny
        run: |
          cd crates
          cargo deny check --config ../deny.toml

  security-semgrep-rust:
    name: Security - Semgrep (Rust)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Semgrep
        run: python -m pip install --upgrade pip semgrep==1.36.0

      - name: Run Semgrep on Rust files
        env:
          SEMGREP_PARALLELISM: "1"
        run: semgrep scan --config .semgrep.yml --error --metrics off --jobs 1 --max-memory 1500 --timeout 45 --include="crates/**/*.rs"

  security-semgrep-dart:
    name: Security - Semgrep (Dart)
    runs-on: ubuntu-latest
    # Disabled: Dart scans exhaust CI memory even with minimal rules
    # Security-critical code (crypto, networking, keys) is in Rust (covered by security-semgrep-rust)
    # Dart layer is primarily UI - manual code review covers UI security
    if: false
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Semgrep
        run: python -m pip install --upgrade pip semgrep==1.36.0

      - name: Run Semgrep on Dart files
        env:
          SEMGREP_PARALLELISM: "1"
        run: semgrep scan --config .semgrep.yml --error --metrics off --jobs 1 --max-memory 2000 --timeout 60 --include="app/lib/**/*.dart"

  # ========================================================================
  # Flutter Quality Gates
  # ========================================================================

  flutter-analyze:
    name: Flutter - Analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Get dependencies
        run: |
          cd app
          flutter pub get --enforce-lockfile

      - name: Analyze code
        run: |
          cd app
          flutter analyze --fatal-infos

  flutter-test:
    name: Flutter - Unit & Widget Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Get dependencies
        run: |
          cd app
          flutter pub get --enforce-lockfile

      - name: Run tests
        run: |
          cd app
          # Exclude security_screens_golden_test.dart which causes FFI segfaults in CI
          flutter test --coverage $(find test -name '*_test.dart' ! -name 'security_screens_golden_test.dart')

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./app/coverage/lcov.info
          flags: flutter
          fail_ci_if_error: false

  flutter-golden-tests:
    name: Flutter - Golden Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Get dependencies
        run: |
          cd app
          flutter pub get --enforce-lockfile

      - name: Run golden tests
        run: |
          cd app
          if find test/golden -name "*.png" | grep -q .; then
            # Exclude security_screens_golden_test.dart which causes FFI segfaults in CI
            flutter test $(find test/golden -name '*_test.dart' ! -name 'security_screens_golden_test.dart')
          else
            echo "No golden images found; skipping golden tests."
          fi

  flutter-integration-tests:
    name: Flutter - Integration Tests
    runs-on: macos-latest  # Use macOS for iOS simulator
    # Skip integration tests in CI - they require a live lightwalletd backend
    if: false
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Build Rust FFI library
        run: |
          cd crates
          cargo build --release --package pirate-ffi-frb --features frb --no-default-features --locked

      - name: Get dependencies
        run: |
          cd app
          flutter pub get --enforce-lockfile

      - name: Run integration tests
        run: |
          cd app
          flutter config --enable-macos-desktop
          flutter test integration_test/ -d macos

  # ========================================================================
  # Build Matrix
  # ========================================================================

  build-matrix:
    name: Build - ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: Android
            os: ubuntu-latest
            build-command: flutter build apk --release --split-per-abi
          - platform: iOS
            os: macos-latest
            build-command: flutter build ios --release --no-codesign
          - platform: Linux
            os: ubuntu-latest
            build-command: flutter build linux --release
          - platform: macOS
            os: macos-latest
            build-command: flutter build macos --release
          - platform: Windows
            os: windows-latest
            build-command: flutter build windows --release

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Setup Android SDK
        if: matrix.platform == 'Android'
        uses: android-actions/setup-android@v3

      - name: Install CocoaPods
        if: matrix.platform == 'iOS'
        run: gem install cocoapods -v ${{ env.COCOAPODS_VERSION }}

      - name: Install Linux dependencies
        if: matrix.platform == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev libsecret-1-dev

      - name: Get dependencies
        run: |
          cd app
          flutter pub get --enforce-lockfile

      - name: Enable Linux desktop
        if: matrix.platform == 'Linux'
        run: flutter config --enable-linux-desktop

      - name: Enable macOS desktop
        if: matrix.platform == 'macOS'
        run: flutter config --enable-macos-desktop

      - name: Enable Windows desktop
        if: matrix.platform == 'Windows'
        run: flutter config --enable-windows-desktop

      - name: Build ${{ matrix.platform }}
        run: |
          cd app
          ${{ matrix.build-command }}

  # ========================================================================
  # Final Status Check
  # ========================================================================

  # ========================================================================
  # Reproducible Packaging & SBOM
  # ========================================================================

  package-android:
    name: Package - Android (APK/AAB + SBOM)
    runs-on: ubuntu-latest
    env:
      REPRODUCIBLE: "1"
      JAVA_VERSION: "21"
      GRADLE_OPTS: "-Dorg.gradle.vfs.watch=false"
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/v'))
    needs:
      - rust-test
      - flutter-test
      - security-audit
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for SOURCE_DATE_EPOCH

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK packages
        run: |
          yes | sdkmanager "platforms;android-${{ env.ANDROID_PLATFORM_VERSION }}" "build-tools;${{ env.ANDROID_BUILD_TOOLS_VERSION }}" "ndk;${{ env.ANDROID_NDK_VERSION }}"
          echo "ANDROID_NDK_HOME=${ANDROID_SDK_ROOT}/ndk/${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=${ANDROID_SDK_ROOT}/ndk/${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev libssl-dev pkg-config

      - name: Set SOURCE_DATE_EPOCH
        run: |
          echo "SOURCE_DATE_EPOCH=$(git log -1 --format=%ct)" >> $GITHUB_ENV

      - name: Verify toolchain pins
        run: |
          chmod +x scripts/verify-toolchain.sh
          scripts/verify-toolchain.sh

      - name: Build Android APK
        run: |
          chmod +x scripts/build-android.sh
          REPRODUCIBLE=1 ./scripts/build-android.sh apk

      - name: Build Android AAB
        run: |
          REPRODUCIBLE=1 ./scripts/build-android.sh bundle

      - name: Generate SBOM
        run: |
          chmod +x scripts/generate-sbom.sh
          ./scripts/generate-sbom.sh dist/sbom

      - name: Generate Provenance
        run: |
          chmod +x scripts/generate-provenance.sh
          ./scripts/generate-provenance.sh dist/android/pirate-unified-wallet-android-V8-unsigned.apk dist/provenance
          ./scripts/generate-provenance.sh dist/android/pirate-unified-wallet-android-unsigned.aab dist/provenance

      - name: Upload APK (V8)
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-unsigned-v8
          path: |
            dist/android/pirate-unified-wallet-android-V8-unsigned.apk
            dist/android/pirate-unified-wallet-android-V8-unsigned.apk.sha256

      - name: Upload APK (V7)
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-unsigned-v7
          path: |
            dist/android/pirate-unified-wallet-android-V7-unsigned.apk
            dist/android/pirate-unified-wallet-android-V7-unsigned.apk.sha256

      - name: Upload APK (x86)
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-unsigned-x86
          path: |
            dist/android/pirate-unified-wallet-android-x86-unsigned.apk
            dist/android/pirate-unified-wallet-android-x86-unsigned.apk.sha256

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: |
            dist/android/*.aab
            dist/android/*.aab.sha256

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: android-sbom
          path: dist/sbom/**/*

      - name: Upload Provenance
        uses: actions/upload-artifact@v4
        with:
          name: android-provenance
          path: dist/provenance/**/*

  package-ios:
    name: Package - iOS (IPA + SBOM)
    runs-on: macos-14
    env:
      REPRODUCIBLE: "1"
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/v'))
    needs:
      - rust-test
      - flutter-test
      - security-audit
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Install CocoaPods
        run: gem install cocoapods -v ${{ env.COCOAPODS_VERSION }}

      - name: Set SOURCE_DATE_EPOCH
        run: |
          echo "SOURCE_DATE_EPOCH=$(git log -1 --format=%ct)" >> $GITHUB_ENV

      - name: Verify toolchain pins
        run: |
          chmod +x scripts/verify-toolchain.sh
          scripts/verify-toolchain.sh

      - name: Build iOS IPA
        run: |
          chmod +x scripts/build-ios.sh
          REPRODUCIBLE=1 ./scripts/build-ios.sh false || {
            echo "iOS build debug: locating Runner.app output"
            if [ -d app/build ]; then
              find app/build -maxdepth 4 -type d -name "iphoneos" -print
              find app/build -path "*/ios/iphoneos/Runner.app" -type d -print
              ls -la app/build/ios || true
              ls -la app/build/ios/iphoneos || true
            else
              echo "app/build does not exist"
            fi
            exit 1
          }

      - name: Build iOS Simulator app
        run: |
          cd app
          flutter build ios --simulator --debug
          SIM_APP="build/ios/iphonesimulator/Runner.app"
          if [ ! -d "$SIM_APP" ]; then
            echo "Simulator app not found at $SIM_APP" >&2
            find build/ios -maxdepth 4 -type d -name "*.app" -print || true
            exit 1
          fi
          OUTPUT_DIR="$GITHUB_WORKSPACE/dist/ios"
          mkdir -p "$OUTPUT_DIR"
          ZIP_PATH="$OUTPUT_DIR/pirate-unified-wallet-ios-simulator.app.zip"
          (cd build/ios/iphonesimulator && zip -X -r "$ZIP_PATH" Runner.app)
          (cd "$OUTPUT_DIR" && shasum -a 256 "$(basename "$ZIP_PATH")" > "$(basename "$ZIP_PATH").sha256")

      - name: Generate SBOM
        run: |
          chmod +x scripts/generate-sbom.sh
          ./scripts/generate-sbom.sh dist/sbom

      - name: Generate Provenance
        run: |
          chmod +x scripts/generate-provenance.sh
          ./scripts/generate-provenance.sh dist/ios/pirate-unified-wallet-ios-unsigned.ipa dist/provenance

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: |
            dist/ios/*.ipa
            dist/ios/*.ipa.sha256

      - name: Upload iOS Simulator app
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-app
          path: |
            dist/ios/pirate-unified-wallet-ios-simulator.app.zip
            dist/ios/pirate-unified-wallet-ios-simulator.app.zip.sha256

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: ios-sbom
          path: dist/sbom/**/*

      - name: Upload Provenance
        uses: actions/upload-artifact@v4
        with:
          name: ios-provenance
          path: dist/provenance/**/*

  package-windows:
    name: Package - Windows (MSIX + SBOM)
    runs-on: windows-latest
    env:
      REPRODUCIBLE: "1"
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/v'))
    needs:
      - rust-test
      - flutter-test
      - security-audit
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Install Perl (OpenSSL build)
        shell: pwsh
        run: |
          choco install strawberryperl --version 5.42.0.1 --no-progress -y
          "C:\Strawberry\perl\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding ascii -Append

      - name: Set SOURCE_DATE_EPOCH
        run: |
          $epoch = git log -1 --format=%ct
          echo "SOURCE_DATE_EPOCH=$epoch" >> $env:GITHUB_ENV

      - name: Verify toolchain pins
        shell: bash
        run: |
          chmod +x scripts/verify-toolchain.sh
          scripts/verify-toolchain.sh

      - name: Build Windows MSIX
        shell: bash
        run: |
          chmod +x scripts/build-windows.sh
          REPRODUCIBLE=1 ./scripts/build-windows.sh

      - name: Generate SBOM
        shell: bash
        env:
          PERL: C:\Strawberry\perl\bin\perl.exe
        run: |
          export PATH="/c/Strawberry/perl/bin:/c/Strawberry/c/bin:$PATH"
          chmod +x scripts/generate-sbom.sh
          ./scripts/generate-sbom.sh dist/sbom

      - name: Generate Provenance
        shell: bash
        run: |
          chmod +x scripts/generate-provenance.sh
          if [ -f dist/windows/pirate-unified-wallet-windows-unsigned.msix ]; then
            ./scripts/generate-provenance.sh dist/windows/pirate-unified-wallet-windows-unsigned.msix dist/provenance
          fi
          if [ -f dist/windows/pirate-unified-wallet-windows-portable-unsigned.zip ]; then
            ./scripts/generate-provenance.sh dist/windows/pirate-unified-wallet-windows-portable-unsigned.zip dist/provenance
          fi

      - name: Upload MSIX
        uses: actions/upload-artifact@v4
        with:
          name: windows-msix
          path: |
            dist/windows/*.msix
            dist/windows/*.msix.sha256
            dist/windows/*.zip
            dist/windows/*.zip.sha256

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: windows-sbom
          path: dist/sbom/**/*

      - name: Upload Provenance
        uses: actions/upload-artifact@v4
        with:
          name: windows-provenance
          path: dist/provenance/**/*

  package-macos:
    name: Package - macOS (DMG + SBOM)
    runs-on: macos-14
    env:
      REPRODUCIBLE: "1"
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/v'))
    needs:
      - rust-test
      - flutter-test
      - security-audit
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Set SOURCE_DATE_EPOCH
        run: |
          echo "SOURCE_DATE_EPOCH=$(git log -1 --format=%ct)" >> $GITHUB_ENV

      - name: Verify toolchain pins
        run: |
          chmod +x scripts/verify-toolchain.sh
          scripts/verify-toolchain.sh

      - name: Build macOS DMG
        run: |
          chmod +x scripts/build-macos.sh
          REPRODUCIBLE=1 ./scripts/build-macos.sh false

      - name: Generate SBOM
        run: |
          chmod +x scripts/generate-sbom.sh
          ./scripts/generate-sbom.sh dist/sbom

      - name: Generate Provenance
        run: |
          chmod +x scripts/generate-provenance.sh
          ./scripts/generate-provenance.sh dist/macos/pirate-unified-wallet-macos-unsigned.dmg dist/provenance

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: |
            dist/macos/*.dmg
            dist/macos/*.dmg.sha256

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: macos-sbom
          path: dist/sbom/**/*

      - name: Upload Provenance
        uses: actions/upload-artifact@v4
        with:
          name: macos-provenance
          path: dist/provenance/**/*

  package-linux:
    name: Package - Linux (AppImage/Flatpak/Deb + SBOM)
    runs-on: ubuntu-latest
    env:
      REPRODUCIBLE: "1"
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/v'))
    needs:
      - rust-test
      - flutter-test
      - security-audit
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libglib2.0-dev \
            libsecret-1-dev \
            libsqlite3-dev \
            libssl-dev \
            pkg-config \
            clang \
            cmake \
            ninja-build \
            libblkid-dev \
            liblzma-dev \
            dpkg-dev \
            squashfs-tools \
            flatpak \
            flatpak-builder

      - name: Set SOURCE_DATE_EPOCH
        run: |
          echo "SOURCE_DATE_EPOCH=$(git log -1 --format=%ct)" >> $GITHUB_ENV

      - name: Verify toolchain pins
        run: |
          chmod +x scripts/verify-toolchain.sh
          scripts/verify-toolchain.sh

      - name: Build AppImage
        run: |
          chmod +x scripts/build-linux.sh
          REPRODUCIBLE=1 ./scripts/build-linux.sh appimage

      - name: Build Flatpak manifest
        run: |
          REPRODUCIBLE=1 ./scripts/build-linux.sh flatpak

      - name: Build Debian package
        run: |
          REPRODUCIBLE=1 ./scripts/build-linux.sh deb

      - name: Generate SBOM
        run: |
          chmod +x scripts/generate-sbom.sh
          ./scripts/generate-sbom.sh dist/sbom

      - name: Generate Provenance
        run: |
          chmod +x scripts/generate-provenance.sh
          ./scripts/generate-provenance.sh dist/linux/pirate-unified-wallet-linux-x86_64.AppImage dist/provenance
          ./scripts/generate-provenance.sh dist/linux/pirate-unified-wallet-amd64.deb dist/provenance

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: |
            dist/linux/*.AppImage
            dist/linux/*.AppImage.sha256

      - name: Upload Flatpak
        uses: actions/upload-artifact@v4
        with:
          name: linux-flatpak
          path: |
            dist/linux/*.flatpak
            com.pirate.wallet.yml

      - name: Upload Debian Package
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: |
            dist/linux/*.deb
            dist/linux/*.deb.sha256
            dist/linux/apt-repo/**/*

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: linux-sbom
          path: dist/sbom/**/*

      - name: Upload Provenance
        uses: actions/upload-artifact@v4
        with:
          name: linux-provenance
          path: dist/provenance/**/*

  # ========================================================================
  # Signed Release Artifacts (Non-Reproducible)
  # ========================================================================

  sign-android:
    name: Sign - Android (APK/AAB)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    env:
      GRADLE_OPTS: "-Dorg.gradle.vfs.watch=false"
    needs:
      - package-android
    steps:
      - name: Check signing secrets
        id: signing
        run: |
          if [ -n "${{ secrets.ANDROID_KEYSTORE_B64 }}" ] && [ -n "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" ] && [ -n "${{ secrets.ANDROID_KEY_ALIAS }}" ]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Java
        if: steps.signing.outputs.enabled == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        if: steps.signing.outputs.enabled == 'true'
        uses: android-actions/setup-android@v3

      - name: Install Android Build Tools
        if: steps.signing.outputs.enabled == 'true'
        run: |
          yes | sdkmanager "build-tools;${{ env.ANDROID_BUILD_TOOLS_VERSION }}"

      - name: Download APK artifacts (V8)
        if: steps.signing.outputs.enabled == 'true'
        uses: actions/download-artifact@v4
        with:
          name: android-apk-unsigned-v8
          path: dist/android

      - name: Download APK artifacts (V7)
        if: steps.signing.outputs.enabled == 'true'
        uses: actions/download-artifact@v4
        with:
          name: android-apk-unsigned-v7
          path: dist/android

      - name: Download APK artifacts (x86)
        if: steps.signing.outputs.enabled == 'true'
        uses: actions/download-artifact@v4
        with:
          name: android-apk-unsigned-x86
          path: dist/android

      - name: Download AAB artifacts
        if: steps.signing.outputs.enabled == 'true'
        uses: actions/download-artifact@v4
        with:
          name: android-aab
          path: dist/android

      - name: Decode keystore
        if: steps.signing.outputs.enabled == 'true'
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_B64 }}" | base64 -d > "$RUNNER_TEMP/keystore.jks"

      - name: Sign APK and AAB
        if: steps.signing.outputs.enabled == 'true'
        env:
          KEYSTORE_PATH: ${{ runner.temp }}/keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          KEY_PASSWORD="${KEY_PASSWORD:-$KEYSTORE_PASSWORD}"
          APKSIGNER="$ANDROID_SDK_ROOT/build-tools/${{ env.ANDROID_BUILD_TOOLS_VERSION }}/apksigner"
          if [ ! -f "$APKSIGNER" ]; then
            echo "apksigner not found at $APKSIGNER" >&2
            exit 1
          fi
          mapfile -t APK_UNSIGNED_LIST < <(ls dist/android/*-unsigned.apk 2>/dev/null || true)
          if [ "${#APK_UNSIGNED_LIST[@]}" -eq 0 ]; then
            echo "No unsigned APKs found in dist/android" >&2
            exit 1
          fi
          for APK_UNSIGNED in "${APK_UNSIGNED_LIST[@]}"; do
            APK_SIGNED="${APK_UNSIGNED/-unsigned.apk/.apk}"
            echo "Signing $APK_UNSIGNED -> $APK_SIGNED"
            "$APKSIGNER" sign \
              --ks "$KEYSTORE_PATH" \
              --ks-key-alias "$KEY_ALIAS" \
              --ks-pass "pass:$KEYSTORE_PASSWORD" \
              --key-pass "pass:$KEY_PASSWORD" \
              --out "$APK_SIGNED" \
              "$APK_UNSIGNED"
            "$APKSIGNER" verify --verbose "$APK_SIGNED"
            sha256sum "$APK_SIGNED" > "$APK_SIGNED.sha256"
          done

          AAB_UNSIGNED="dist/android/pirate-unified-wallet-android-unsigned.aab"
          AAB_SIGNED="dist/android/pirate-unified-wallet-android.aab"
          if [ ! -f "$AAB_UNSIGNED" ]; then
            echo "Unsigned AAB not found at $AAB_UNSIGNED" >&2
            exit 1
          fi
          cp "$AAB_UNSIGNED" "$AAB_SIGNED"
          jarsigner -verbose \
            -sigalg SHA256withRSA \
            -digestalg SHA-256 \
            -keystore "$KEYSTORE_PATH" \
            -storepass "$KEYSTORE_PASSWORD" \
            -keypass "$KEY_PASSWORD" \
            "$AAB_SIGNED" \
            "$KEY_ALIAS"
          sha256sum "$AAB_SIGNED" > "$AAB_SIGNED.sha256"

      - name: Upload signed APK (V8)
        if: steps.signing.outputs.enabled == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-signed-v8
          path: |
            dist/android/pirate-unified-wallet-android-V8.apk
            dist/android/pirate-unified-wallet-android-V8.apk.sha256
          if-no-files-found: error

      - name: Upload signed APK (V7)
        if: steps.signing.outputs.enabled == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-signed-v7
          path: |
            dist/android/pirate-unified-wallet-android-V7.apk
            dist/android/pirate-unified-wallet-android-V7.apk.sha256
          if-no-files-found: error

      - name: Upload signed APK (x86)
        if: steps.signing.outputs.enabled == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-signed-x86
          path: |
            dist/android/pirate-unified-wallet-android-x86.apk
            dist/android/pirate-unified-wallet-android-x86.apk.sha256
          if-no-files-found: error

      - name: Upload signed AAB
        if: steps.signing.outputs.enabled == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-signed
          path: |
            dist/android/pirate-unified-wallet-android.aab
            dist/android/pirate-unified-wallet-android.aab.sha256
          if-no-files-found: error

  sign-windows:
    name: Sign - Windows (MSIX/Portable)
    runs-on: windows-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    needs:
      - package-windows
    steps:
      - name: Check signing secrets
        id: signing
        shell: pwsh
        run: |
          if ("${{ secrets.WINDOWS_SIGN_CERT_PFX_B64 }}" -and "${{ secrets.WINDOWS_SIGN_CERT_PASSWORD }}") {
            "enabled=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding ascii -Append
          } else {
            "enabled=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding ascii -Append
          }

      - name: Download Windows artifacts
        if: steps.signing.outputs.enabled == 'true'
        uses: actions/download-artifact@v4
        with:
          name: windows-msix
          path: dist/windows

      - name: Decode Windows signing certificate
        if: steps.signing.outputs.enabled == 'true'
        shell: pwsh
        run: |
          $certPath = Join-Path $env:RUNNER_TEMP "windows-signing.pfx"
          [IO.File]::WriteAllBytes($certPath, [Convert]::FromBase64String("${{ secrets.WINDOWS_SIGN_CERT_PFX_B64 }}"))
          "WINDOWS_SIGN_CERT=$certPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding ascii -Append

      - name: Sign Windows artifacts
        if: steps.signing.outputs.enabled == 'true'
        shell: pwsh
        run: |
          $signtoolPath = $null
          $signtool = (Get-Command signtool.exe -ErrorAction SilentlyContinue)
          if ($signtool) { $signtoolPath = $signtool.Source }
          if (-not $signtoolPath) {
            $signtool = (Get-Command signtool -ErrorAction SilentlyContinue)
            if ($signtool) { $signtoolPath = $signtool.Source }
          }
          if (-not $signtoolPath) {
            $kitRoots = @()
            $pf86 = [Environment]::GetEnvironmentVariable('ProgramFiles(x86)')
            if ($pf86) { $kitRoots += (Join-Path $pf86 'Windows Kits\\10\\bin') }
            $pf = [Environment]::GetEnvironmentVariable('ProgramFiles')
            if ($pf) { $kitRoots += (Join-Path $pf 'Windows Kits\\10\\bin') }
            $kitRoots += 'C:\\Program Files (x86)\\Windows Kits\\10\\bin'
            $kitRoots += 'C:\\Program Files\\Windows Kits\\10\\bin'
            $kitRoots = $kitRoots | Select-Object -Unique
            foreach ($kitRoot in $kitRoots) {
              if (-not (Test-Path $kitRoot)) { continue }
              $signtoolCandidate = Get-ChildItem -Path (Join-Path $kitRoot '10.*\\x64\\signtool.exe') -ErrorAction SilentlyContinue |
                Select-Object -First 1
              if (-not $signtoolCandidate) {
                $versionDirs = Get-ChildItem -Path $kitRoot -Directory -ErrorAction SilentlyContinue |
                  Sort-Object Name -Descending
                foreach ($dir in $versionDirs) {
                  $candidate = Join-Path $dir.FullName 'x64\\signtool.exe'
                  if (Test-Path $candidate) {
                    $signtoolPath = $candidate
                    break
                  }
                }
              } else {
                $signtoolPath = $signtoolCandidate.FullName
              }
              if ($signtoolPath) { break }
            }
          }
          if (-not $signtoolPath) {
            Write-Host "signtool not found. Attempting to install Windows SDK..."
            choco install windows-sdk-10.0.22621.0 -y --no-progress
            $kitRoot = 'C:\\Program Files (x86)\\Windows Kits\\10\\bin'
            if (Test-Path $kitRoot) {
              $signtoolCandidate = Get-ChildItem -Path (Join-Path $kitRoot '10.*\\x64\\signtool.exe') -ErrorAction SilentlyContinue |
                Select-Object -First 1
              if ($signtoolCandidate) { $signtoolPath = $signtoolCandidate.FullName }
            }
          }
          if (-not $signtoolPath) {
            Write-Error "signtool not found on PATH or in Windows Kits"
            exit 1
          }

          $cert = $env:WINDOWS_SIGN_CERT
          $pass = "${{ secrets.WINDOWS_SIGN_CERT_PASSWORD }}"

          $msixUnsigned = "dist/windows/pirate-unified-wallet-windows-unsigned.msix"
          $msixSigned = "dist/windows/pirate-unified-wallet-windows.msix"
          if (Test-Path $msixUnsigned) {
            Copy-Item $msixUnsigned $msixSigned -Force
            & $signtoolPath sign /fd SHA256 /f $cert /p $pass $msixSigned
            (Get-FileHash -Algorithm SHA256 $msixSigned).Hash | Set-Content -Encoding ascii "$msixSigned.sha256"
          } else {
            Write-Host "Unsigned MSIX not found; skipping MSIX signing."
          }

          $zipUnsigned = "dist/windows/pirate-unified-wallet-windows-portable-unsigned.zip"
          $zipSigned = "dist/windows/pirate-unified-wallet-windows-portable.zip"
          if (-not (Test-Path $zipUnsigned)) {
            Write-Error "Unsigned portable zip not found"
            exit 1
          }
          $tempDir = Join-Path $env:RUNNER_TEMP "portable"
          if (Test-Path $tempDir) { Remove-Item $tempDir -Recurse -Force }
          Expand-Archive -Path $zipUnsigned -DestinationPath $tempDir
          Get-ChildItem $tempDir -Recurse -Include *.exe,*.dll | ForEach-Object {
            & $signtoolPath sign /fd SHA256 /f $cert /p $pass $_.FullName
          }
          if (Test-Path $zipSigned) { Remove-Item $zipSigned -Force }
          Compress-Archive -Path (Join-Path $tempDir '*') -DestinationPath $zipSigned
          (Get-FileHash -Algorithm SHA256 $zipSigned).Hash | Set-Content -Encoding ascii "$zipSigned.sha256"

      - name: Upload signed Windows artifacts
        if: steps.signing.outputs.enabled == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: windows-signed
          path: |
            dist/windows/pirate-unified-wallet-windows.msix
            dist/windows/pirate-unified-wallet-windows.msix.sha256
            dist/windows/pirate-unified-wallet-windows-portable.zip
            dist/windows/pirate-unified-wallet-windows-portable.zip.sha256
          if-no-files-found: warn

  sign-macos:
    name: Sign - macOS (DMG)
    runs-on: macos-14
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    needs:
      - package-macos
    steps:
      - name: Check signing secrets
        id: signing
        run: |
          if [ -n "${{ secrets.MACOS_SIGN_CERT_P12_B64 }}" ] && [ -n "${{ secrets.MACOS_SIGN_CERT_PASSWORD }}" ]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
            echo "mode=provided" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=true" >> "$GITHUB_OUTPUT"
            echo "mode=selfsigned" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/checkout@v4
        if: steps.signing.outputs.enabled == 'true'
        with:
          fetch-depth: 0

      - name: Setup Flutter
        if: steps.signing.outputs.enabled == 'true'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        if: steps.signing.outputs.enabled == 'true'
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Setup Go
        if: steps.signing.outputs.enabled == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Import macOS signing certificate
        if: steps.signing.outputs.mode == 'provided'
        env:
          CERT_PASSWORD: ${{ secrets.MACOS_SIGN_CERT_PASSWORD }}
        run: |
          CERT_PATH="$RUNNER_TEMP/macos-signing.p12"
          echo "${{ secrets.MACOS_SIGN_CERT_P12_B64 }}" | base64 -d > "$CERT_PATH"
          KEYCHAIN="$RUNNER_TEMP/macos-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(uuidgen)"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security set-keychain-settings -t 3600 -u "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security import "$CERT_PATH" -k "$KEYCHAIN" -P "$CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychains -s "$KEYCHAIN"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          echo "MACOS_SIGN_KEYCHAIN=$KEYCHAIN" >> "$GITHUB_ENV"
          echo "MACOS_SIGN_KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> "$GITHUB_ENV"

      - name: Generate self-signed macOS certificate
        if: steps.signing.outputs.mode == 'selfsigned'
        run: |
          KEYCHAIN="$RUNNER_TEMP/macos-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(uuidgen)"
          CERT_PASSWORD="$(uuidgen)"
          CERT_KEY="$RUNNER_TEMP/macos-signing.key"
          CERT_CRT="$RUNNER_TEMP/macos-signing.crt"
          CERT_P12="$RUNNER_TEMP/macos-signing.p12"
          CERT_SUBJ="/CN=Pirate Unified Wallet CI Self-Signed"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security set-keychain-settings -t 3600 -u "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"

          openssl req -newkey rsa:2048 -nodes -keyout "$CERT_KEY" -x509 -days 365 \
            -out "$CERT_CRT" -subj "$CERT_SUBJ" \
            -addext "keyUsage=digitalSignature" \
            -addext "extendedKeyUsage=codeSigning"

          openssl pkcs12 -export -inkey "$CERT_KEY" -in "$CERT_CRT" -out "$CERT_P12" \
            -password "pass:$CERT_PASSWORD"

          security import "$CERT_P12" -k "$KEYCHAIN" -P "$CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychains -s "$KEYCHAIN"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          echo "MACOS_SIGN_KEYCHAIN=$KEYCHAIN" >> "$GITHUB_ENV"
          echo "MACOS_SIGN_KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> "$GITHUB_ENV"
          echo "MACOS_SIGN_IDENTITY=Pirate Unified Wallet CI Self-Signed" >> "$GITHUB_ENV"

      - name: Resolve macOS signing identity
        if: steps.signing.outputs.enabled == 'true'
        run: |
          KEYCHAIN="${MACOS_SIGN_KEYCHAIN:-$RUNNER_TEMP/macos-signing.keychain-db}"
          if [ -f "$KEYCHAIN" ] && [ -n "${MACOS_SIGN_KEYCHAIN_PASSWORD:-}" ]; then
            security unlock-keychain -p "$MACOS_SIGN_KEYCHAIN_PASSWORD" "$KEYCHAIN"
            security list-keychains -s "$KEYCHAIN"
            security default-keychain -s "$KEYCHAIN"
          fi

          if [ -n "${MACOS_SIGN_IDENTITY:-}" ]; then
            echo "MACOS_SIGN_IDENTITY=$MACOS_SIGN_IDENTITY" >> "$GITHUB_ENV"
            exit 0
          fi

          if [ -n "${{ secrets.MACOS_SIGN_IDENTITY }}" ]; then
            echo "MACOS_SIGN_IDENTITY=${{ secrets.MACOS_SIGN_IDENTITY }}" >> "$GITHUB_ENV"
            exit 0
          fi

          if [ -f "$KEYCHAIN" ]; then
            IDENTITY="$(security find-identity -v -p codesigning "$KEYCHAIN" | awk -F '\"' 'NR==1 {print $2}')"
          else
            IDENTITY="$(security find-identity -v -p codesigning | awk -F '\"' 'NR==1 {print $2}')"
          fi
          if [ -z "$IDENTITY" ]; then
            echo "No code signing identity found after import" >&2
            if [ -f "$KEYCHAIN" ]; then
              security find-identity -v -p codesigning "$KEYCHAIN" || true
            else
              security find-identity -v -p codesigning || true
            fi
            exit 1
          fi
          echo "MACOS_SIGN_IDENTITY=$IDENTITY" >> "$GITHUB_ENV"

      - name: Build signed macOS DMG
        if: steps.signing.outputs.enabled == 'true'
        env:
          MACOS_NOTARIZE: ${{ secrets.MACOS_NOTARIZE }}
          MACOS_APPLE_ID: ${{ secrets.MACOS_APPLE_ID }}
          MACOS_TEAM_ID: ${{ secrets.MACOS_TEAM_ID }}
          MACOS_APP_PASSWORD: ${{ secrets.MACOS_APP_PASSWORD }}
        run: |
          chmod +x scripts/build-macos.sh
          REPRODUCIBLE=0 ./scripts/build-macos.sh true

      - name: Upload signed DMG
        if: steps.signing.outputs.enabled == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg-signed
          path: |
            dist/macos/pirate-unified-wallet-macos.dmg
            dist/macos/pirate-unified-wallet-macos.dmg.sha256
          if-no-files-found: error

  sign-ios:
    name: Sign - iOS (IPA)
    runs-on: macos-14
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    needs:
      - package-ios
    steps:
      - name: Check signing secrets
        id: signing
        run: |
          if [ -n "${{ secrets.IOS_SIGNING_CERT_P12_B64 }}" ] && [ -n "${{ secrets.IOS_SIGNING_CERT_PASSWORD }}" ] && [ -n "${{ secrets.IOS_PROVISIONING_PROFILE_B64 }}" ] && [ -n "${{ secrets.IOS_EXPORT_OPTIONS_PLIST_B64 }}" ]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/checkout@v4
        if: steps.signing.outputs.enabled == 'true'
        with:
          fetch-depth: 0

      - name: Setup Flutter
        if: steps.signing.outputs.enabled == 'true'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        if: steps.signing.outputs.enabled == 'true'
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Install CocoaPods
        if: steps.signing.outputs.enabled == 'true'
        run: gem install cocoapods -v ${{ env.COCOAPODS_VERSION }}

      - name: Import iOS signing certificate
        if: steps.signing.outputs.enabled == 'true'
        env:
          CERT_PASSWORD: ${{ secrets.IOS_SIGNING_CERT_PASSWORD }}
        run: |
          CERT_PATH="$RUNNER_TEMP/ios-signing.p12"
          echo "${{ secrets.IOS_SIGNING_CERT_P12_B64 }}" | base64 -d > "$CERT_PATH"
          KEYCHAIN="$RUNNER_TEMP/ios-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(uuidgen)"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security set-keychain-settings -t 3600 -u "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security import "$CERT_PATH" -k "$KEYCHAIN" -P "$CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychains -s "$KEYCHAIN"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN"

      - name: Install provisioning profile
        if: steps.signing.outputs.enabled == 'true'
        run: |
          PROFILE_PATH="$RUNNER_TEMP/profile.mobileprovision"
          echo "${{ secrets.IOS_PROVISIONING_PROFILE_B64 }}" | base64 -d > "$PROFILE_PATH"
          PROFILE_PLIST="$RUNNER_TEMP/profile.plist"
          security cms -D -i "$PROFILE_PATH" > "$PROFILE_PLIST"
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' "$PROFILE_PLIST")
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$PROFILE_PATH" "$HOME/Library/MobileDevice/Provisioning Profiles/$PROFILE_UUID.mobileprovision"

      - name: Install ExportOptions.plist
        if: steps.signing.outputs.enabled == 'true'
        run: |
          echo "${{ secrets.IOS_EXPORT_OPTIONS_PLIST_B64 }}" | base64 -d > app/ios/ExportOptions.plist

      - name: Build signed iOS IPA
        if: steps.signing.outputs.enabled == 'true'
        run: |
          chmod +x scripts/build-ios.sh
          REPRODUCIBLE=0 ./scripts/build-ios.sh true

      - name: Upload signed IPA
        if: steps.signing.outputs.enabled == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-signed
          path: |
            dist/ios/pirate-unified-wallet-ios.ipa
            dist/ios/pirate-unified-wallet-ios.ipa.sha256
          if-no-files-found: error

  sign-linux:
    name: Sign - Linux (GPG)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    needs:
      - package-linux
    steps:
      - name: Check signing secrets
        id: signing
        run: |
          if [ -n "${{ secrets.LINUX_GPG_PRIVATE_KEY_B64 }}" ] && [ -n "${{ secrets.LINUX_GPG_PASSPHRASE }}" ]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Download AppImage artifacts
        if: steps.signing.outputs.enabled == 'true'
        uses: actions/download-artifact@v4
        with:
          name: linux-appimage
          path: dist/linux

      - name: Download Debian artifacts
        if: steps.signing.outputs.enabled == 'true'
        uses: actions/download-artifact@v4
        with:
          name: linux-deb
          path: dist/linux

      - name: Download Flatpak artifacts
        if: steps.signing.outputs.enabled == 'true'
        uses: actions/download-artifact@v4
        with:
          name: linux-flatpak
          path: dist/linux

      - name: Import GPG key
        if: steps.signing.outputs.enabled == 'true'
        env:
          GPG_PASSPHRASE: ${{ secrets.LINUX_GPG_PASSPHRASE }}
        run: |
          echo "${{ secrets.LINUX_GPG_PRIVATE_KEY_B64 }}" | base64 -d | gpg --batch --import

      - name: Sign Linux artifacts
        if: steps.signing.outputs.enabled == 'true'
        env:
          GPG_PASSPHRASE: ${{ secrets.LINUX_GPG_PASSPHRASE }}
        run: |
          set -euo pipefail
          shopt -s nullglob
          for file in dist/linux/*.AppImage dist/linux/*.deb dist/linux/*.flatpak; do
            gpg --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" --armor --detach-sign "$file"
          done

      - name: Upload Linux signatures
        if: steps.signing.outputs.enabled == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: linux-signatures
          path: dist/linux/*.asc
          if-no-files-found: warn

  release:
    name: Release - Publish Artifacts
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    needs:
      - ci-success
      - sign-android
      - sign-windows
      - sign-macos
      - sign-ios
      - sign-linux
    steps:
      - name: Checkout tag for release notes
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Collect release files
        run: |
          set -euo pipefail
          mkdir -p release release-meta

          # Signed artifacts.
          find release-artifacts -type f \( \
            -name 'pirate-unified-wallet-android-*.apk' \
            -o -name 'pirate-unified-wallet-android.aab' \
            -o -name 'pirate-unified-wallet-windows.msix' \
            -o -name 'pirate-unified-wallet-windows-portable.zip' \
            -o -name 'pirate-unified-wallet-macos.dmg' \
            -o -name 'pirate-unified-wallet-ios.ipa' \
          \) ! -name '*-unsigned*' -exec cp -f {} release/ \;

          # Linux packages (distributed with detached signatures) + iOS simulator.
          find release-artifacts -type f \( \
            -name '*.AppImage' \
            -o -name '*.deb' \
            -o -name '*.flatpak' \
            -o -name 'pirate-unified-wallet-ios-simulator.app.zip' \
          \) -exec cp -f {} release/ \;

          # Hashes and signatures (packaged into a single zip).
          find release-artifacts -type f \( \
            -name '*.sha256' \
            -o -name '*.asc' \
          \) -exec cp -f {} release-meta/ \;

          # Flatpak hashes are not generated during packaging.
          for flatpak in release/*.flatpak; do
            hash_name="release-meta/$(basename "$flatpak").sha256"
            if [ -f "$flatpak" ] && [ ! -f "$hash_name" ]; then
              sha256sum "$flatpak" > "$hash_name"
            fi
          done

          if ls release-meta/* >/dev/null 2>&1; then
            (cd release-meta && zip -q ../release/pirate-unified-wallet-release-metadata.zip ./*)
          else
            echo "No release metadata files found to package."
          fi

          echo "Release files:"
          ls -la release

      - name: Build release notes from annotated tag
        run: |
          set -euo pipefail
          TAG_NAME="${GITHUB_REF_NAME}"
          TAG_REF="refs/tags/$TAG_NAME"
          TAG_TYPE="$(git cat-file -t "$TAG_REF" 2>/dev/null || true)"
          if [ "$TAG_TYPE" = "tag" ]; then
            TAG_BODY="$(git cat-file -p "$TAG_REF" | sed -n '1,/^$/d')"
          else
            echo "Tag '$TAG_NAME' is lightweight; using commit message fallback."
            COMMIT_SHA="$(git rev-parse "$TAG_REF" 2>/dev/null || true)"
            if [ -n "$COMMIT_SHA" ]; then
              COMMIT_SUBJECT="$(git log -1 --format=%s "$COMMIT_SHA")"
              COMMIT_BODY="$(git log -1 --format=%b "$COMMIT_SHA")"
              if [ -n "$COMMIT_BODY" ]; then
                TAG_BODY="$(printf "%s\n\n%s" "$COMMIT_SUBJECT" "$COMMIT_BODY")"
              else
                TAG_BODY="$COMMIT_SUBJECT"
              fi
            else
              TAG_BODY="$TAG_NAME"
            fi
          fi
          mkdir -p release-notes
          printf "%s\n" "$TAG_BODY" > release-notes/RELEASE_NOTES.md

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          body_path: release-notes/RELEASE_NOTES.md

  ci-success:
    name: CI - All Checks Passed
    runs-on: ubuntu-latest
    needs:
      - frb-codegen
      - rust-lint
      - rust-test
      - rust-property-tests
      - rust-migration-tests
      - rust-perf-tests
      - security-audit
      - security-deny
      - security-semgrep-rust
      # security-semgrep-dart disabled due to CI memory constraints
      - flutter-analyze
      - flutter-test
      - flutter-golden-tests
      - build-matrix
      - package-android
      - package-ios
      - package-windows
      - package-macos
      - package-linux
    steps:
      - name: All checks passed
        run: echo " All CI checks passed successfully! Artifacts ready for distribution."
