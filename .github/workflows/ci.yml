name: CI - Pirate Unified Wallet

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  RUST_VERSION: "1.75.0"
  FLUTTER_VERSION: "3.24.0"
  CARGO_TERM_COLOR: always

jobs:
  frb-codegen:
    name: FRB - Codegen
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-frb-${{ hashFiles('**/Cargo.lock') }}

      - name: Generate flutter_rust_bridge bindings (make frb)
        run: make frb

      - name: Verify bindings are up to date
        run: git diff --exit-code

  # ========================================================================
  # Rust Quality Gates
  # ========================================================================

  rust-lint:
    name: Rust - Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: crates/target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: |
          cd crates
          cargo fmt --all -- --check

      - name: Run clippy
        run: |
          cd crates
          cargo clippy --all-targets --all-features -- -D warnings

  rust-test:
    name: Rust - Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            crates/target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}

      - name: Run unit tests
        run: |
          cd crates
          cargo test --all-features

  rust-property-tests:
    name: Rust - Property Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            crates/target
          key: ${{ runner.os }}-cargo-proptest-${{ hashFiles('**/Cargo.lock') }}

      - name: Run property tests
        run: |
          cd crates/pirate-core
          cargo test --test property_tests --release

  rust-migration-tests:
    name: Rust - Migration Snapshot Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            crates/target
          key: ${{ runner.os }}-cargo-migration-${{ hashFiles('**/Cargo.lock') }}

      - name: Run migration tests
        run: |
          cd crates/pirate-storage-sqlite
          cargo test --test migration_snapshots

  rust-perf-tests:
    name: Rust - Performance Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            crates/target
          key: ${{ runner.os }}-cargo-perf-${{ hashFiles('**/Cargo.lock') }}

      - name: Run performance benchmarks
        run: |
          cd crates/pirate-sync-lightd
          cargo test --test performance_benchmarks --release -- --nocapture

  # ========================================================================
  # Security Audits
  # ========================================================================

  security-audit:
    name: Security - Cargo Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run cargo audit
        run: |
          cd crates
          cargo audit

  security-deny:
    name: Security - Cargo Deny
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Run cargo deny
        run: cargo deny check

  security-semgrep:
    name: Security - Semgrep
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: .semgrep.yml

  # ========================================================================
  # Flutter Quality Gates
  # ========================================================================

  flutter-analyze:
    name: Flutter - Analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Get dependencies
        run: |
          cd app
          flutter pub get

      - name: Analyze code
        run: |
          cd app
          flutter analyze --fatal-infos

  flutter-test:
    name: Flutter - Unit & Widget Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Get dependencies
        run: |
          cd app
          flutter pub get

      - name: Run tests
        run: |
          cd app
          flutter test --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./app/coverage/lcov.info
          flags: flutter

  flutter-golden-tests:
    name: Flutter - Golden Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Get dependencies
        run: |
          cd app
          flutter pub get

      - name: Run golden tests
        run: |
          cd app
          flutter test --update-goldens
          flutter test test/golden/

  flutter-integration-tests:
    name: Flutter - Integration Tests
    runs-on: macos-latest  # Use macOS for iOS simulator
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Get dependencies
        run: |
          cd app
          flutter pub get

      - name: Run integration tests
        run: |
          cd app
          flutter test integration_test/

  # ========================================================================
  # Build Matrix
  # ========================================================================

  build-matrix:
    name: Build - ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: Android
            os: ubuntu-latest
            build-command: flutter build apk --release
          - platform: iOS
            os: macos-latest
            build-command: flutter build ios --release --no-codesign
          - platform: Linux
            os: ubuntu-latest
            build-command: flutter build linux --release
          - platform: macOS
            os: macos-latest
            build-command: flutter build macos --release
          - platform: Windows
            os: windows-latest
            build-command: flutter build windows --release

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Install Linux dependencies
        if: matrix.platform == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev

      - name: Get dependencies
        run: |
          cd app
          flutter pub get

      - name: Build ${{ matrix.platform }}
        run: |
          cd app
          ${{ matrix.build-command }}

  # ========================================================================
  # Final Status Check
  # ========================================================================

  # ========================================================================
  # Reproducible Packaging & SBOM
  # ========================================================================

  package-android:
    name: Package - Android (APK/AAB + SBOM)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    needs:
      - rust-test
      - flutter-test
      - security-audit
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for SOURCE_DATE_EPOCH

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev libssl-dev pkg-config

      - name: Set SOURCE_DATE_EPOCH
        run: |
          echo "SOURCE_DATE_EPOCH=$(git log -1 --format=%ct)" >> $GITHUB_ENV

      - name: Build Android APK
        run: |
          chmod +x scripts/build-android.sh
          ./scripts/build-android.sh apk

      - name: Build Android AAB
        run: |
          ./scripts/build-android.sh bundle

      - name: Generate SBOM
        run: |
          chmod +x scripts/generate-sbom.sh
          ./scripts/generate-sbom.sh dist/sbom

      - name: Generate Provenance
        run: |
          chmod +x scripts/generate-provenance.sh
          ./scripts/generate-provenance.sh dist/android/pirate-unified-wallet-android-arm64-v8a.apk dist/provenance
          ./scripts/generate-provenance.sh dist/android/pirate-unified-wallet-android.aab dist/provenance

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: |
            dist/android/*.apk
            dist/android/*.apk.sha256

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: |
            dist/android/*.aab
            dist/android/*.aab.sha256

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: android-sbom
          path: dist/sbom/**/*

      - name: Upload Provenance
        uses: actions/upload-artifact@v4
        with:
          name: android-provenance
          path: dist/provenance/**/*

  package-ios:
    name: Package - iOS (IPA + SBOM)
    runs-on: macos-14
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    needs:
      - rust-test
      - flutter-test
      - security-audit
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Install CocoaPods
        run: gem install cocoapods

      - name: Set SOURCE_DATE_EPOCH
        run: |
          echo "SOURCE_DATE_EPOCH=$(git log -1 --format=%ct)" >> $GITHUB_ENV

      - name: Build iOS IPA
        run: |
          chmod +x scripts/build-ios.sh
          ./scripts/build-ios.sh false  # unsigned for CI

      - name: Generate SBOM
        run: |
          chmod +x scripts/generate-sbom.sh
          ./scripts/generate-sbom.sh dist/sbom

      - name: Generate Provenance
        run: |
          chmod +x scripts/generate-provenance.sh
          ./scripts/generate-provenance.sh dist/ios/pirate-unified-wallet-ios.ipa dist/provenance

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: |
            dist/ios/*.ipa
            dist/ios/*.ipa.sha256

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: ios-sbom
          path: dist/sbom/**/*

      - name: Upload Provenance
        uses: actions/upload-artifact@v4
        with:
          name: ios-provenance
          path: dist/provenance/**/*

  package-windows:
    name: Package - Windows (MSIX + SBOM)
    runs-on: windows-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    needs:
      - rust-test
      - flutter-test
      - security-audit
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Set SOURCE_DATE_EPOCH
        run: |
          $epoch = git log -1 --format=%ct
          echo "SOURCE_DATE_EPOCH=$epoch" >> $env:GITHUB_ENV

      - name: Build Windows MSIX
        shell: bash
        run: |
          chmod +x scripts/build-windows.sh
          ./scripts/build-windows.sh

      - name: Generate SBOM
        shell: bash
        run: |
          chmod +x scripts/generate-sbom.sh
          ./scripts/generate-sbom.sh dist/sbom

      - name: Generate Provenance
        shell: bash
        run: |
          chmod +x scripts/generate-provenance.sh
          ./scripts/generate-provenance.sh dist/windows/pirate-unified-wallet-windows.msix dist/provenance

      - name: Upload MSIX
        uses: actions/upload-artifact@v4
        with:
          name: windows-msix
          path: |
            dist/windows/*.msix
            dist/windows/*.msix.sha256
            dist/windows/*.zip
            dist/windows/*.zip.sha256

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: windows-sbom
          path: dist/sbom/**/*

      - name: Upload Provenance
        uses: actions/upload-artifact@v4
        with:
          name: windows-provenance
          path: dist/provenance/**/*

  package-macos:
    name: Package - macOS (DMG + SBOM)
    runs-on: macos-14
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    needs:
      - rust-test
      - flutter-test
      - security-audit
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Set SOURCE_DATE_EPOCH
        run: |
          echo "SOURCE_DATE_EPOCH=$(git log -1 --format=%ct)" >> $GITHUB_ENV

      - name: Build macOS DMG
        run: |
          chmod +x scripts/build-macos.sh
          ./scripts/build-macos.sh false  # unsigned for CI

      - name: Generate SBOM
        run: |
          chmod +x scripts/generate-sbom.sh
          ./scripts/generate-sbom.sh dist/sbom

      - name: Generate Provenance
        run: |
          chmod +x scripts/generate-provenance.sh
          ./scripts/generate-provenance.sh dist/macos/pirate-unified-wallet-macos.dmg dist/provenance

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: |
            dist/macos/*.dmg
            dist/macos/*.dmg.sha256

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: macos-sbom
          path: dist/sbom/**/*

      - name: Upload Provenance
        uses: actions/upload-artifact@v4
        with:
          name: macos-provenance
          path: dist/provenance/**/*

  package-linux:
    name: Package - Linux (AppImage/Flatpak/Deb + SBOM)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    needs:
      - rust-test
      - flutter-test
      - security-audit
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libglib2.0-dev \
            libsqlite3-dev \
            libssl-dev \
            pkg-config \
            clang \
            cmake \
            ninja-build \
            libblkid-dev \
            liblzma-dev \
            flatpak \
            flatpak-builder

      - name: Set SOURCE_DATE_EPOCH
        run: |
          echo "SOURCE_DATE_EPOCH=$(git log -1 --format=%ct)" >> $GITHUB_ENV

      - name: Build AppImage
        run: |
          chmod +x scripts/build-linux.sh
          ./scripts/build-linux.sh appimage

      - name: Build Flatpak manifest
        run: |
          ./scripts/build-linux.sh flatpak

      - name: Build Debian package
        run: |
          ./scripts/build-linux.sh deb

      - name: Generate SBOM
        run: |
          chmod +x scripts/generate-sbom.sh
          ./scripts/generate-sbom.sh dist/sbom

      - name: Generate Provenance
        run: |
          chmod +x scripts/generate-provenance.sh
          ./scripts/generate-provenance.sh dist/linux/pirate-unified-wallet-linux-x86_64.AppImage dist/provenance
          ./scripts/generate-provenance.sh dist/linux/pirate-unified-wallet_1.0.0_amd64.deb dist/provenance

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: |
            dist/linux/*.AppImage
            dist/linux/*.AppImage.sha256

      - name: Upload Flatpak
        uses: actions/upload-artifact@v4
        with:
          name: linux-flatpak
          path: |
            dist/linux/*.flatpak
            black.pirate.wallet.yml

      - name: Upload Debian Package
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: |
            dist/linux/*.deb
            dist/linux/*.deb.sha256
            dist/linux/apt-repo/**/*

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: linux-sbom
          path: dist/sbom/**/*

      - name: Upload Provenance
        uses: actions/upload-artifact@v4
        with:
          name: linux-provenance
          path: dist/provenance/**/*

  ci-success:
    name: CI - All Checks Passed
    runs-on: ubuntu-latest
    needs:
      - frb-codegen
      - rust-lint
      - rust-test
      - rust-property-tests
      - rust-migration-tests
      - rust-perf-tests
      - security-audit
      - security-deny
      - security-semgrep
      - flutter-analyze
      - flutter-test
      - flutter-golden-tests
      - flutter-integration-tests
      - build-matrix
      - package-android
      - package-ios
      - package-windows
      - package-macos
      - package-linux
    steps:
      - name: All checks passed
        run: echo "âœ… All CI checks passed successfully! Artifacts ready for distribution."
